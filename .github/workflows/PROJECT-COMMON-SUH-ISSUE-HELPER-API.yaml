# ===================================================
# SUH-ISSUE-HELPER-API (ÎπÑÌôúÏÑ±ÌôîÎê®)
# ===================================================
#
# Ïù¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞Îäî lab.suhsaechan.kr APIÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.
#
# ‚ö†Ô∏è ÏÇ¨Ïö© Ï°∞Í±¥:
#   - lab.suhsaechan.kr ÏÇ¨Ïù¥Ìä∏Ïùò Ïù¥ÏäàÎèÑÏö∞ÎØ∏ Í∏∞Îä•ÏùÑ Ìïú Î≤à Ïù¥ÏÉÅ ÏÇ¨Ïö©Ìïú Î†àÌè¨ÏßÄÌÜ†Î¶¨Îßå Ïù¥Ïö© Í∞ÄÎä•
#   - Public Î†àÌè¨ÏßÄÌÜ†Î¶¨ÏóêÏÑúÎßå ÏûëÎèô
#
# üìå ÌòÑÏû¨ ÏÉÅÌÉú: ÎπÑÌôúÏÑ±Ìôî (MODULE Î≤ÑÏ†Ñ ÏÇ¨Ïö© Í∂åÏû•)
#   - ÎåÄÏïà: PROJECT-COMMON-SUH-ISSUE-HELPER-MODULE.yml ÏÇ¨Ïö©
#
# ===================================================

name: PROJECT-COMMON-SUH-ISSUE-HELPER-API

on:
  # ÎπÑÌôúÏÑ±Ìôî: ÏàòÎèô Ìä∏Î¶¨Í±∞Î°ú Î≥ÄÍ≤Ω
  workflow_dispatch:
  # issues:
  #   types: [opened, reopened]

jobs:
  add-comment:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get Issue information
        id: issue-info
        run: |
          echo "ISSUE_URL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV

      - name: Call Suh Project Utility API (multipart)
        id: api-call
        shell: bash
        run: |
          set -euo pipefail
          URL='https://lab.suhsaechan.kr/api/issue-helper/create/commit-branch/github-workflow'
          RESPONSE=$(curl -sS -X POST \
            -H 'Accept: application/json' \
            -F "issueUrl=${ISSUE_URL}" \
            "${URL}" -w '\n%{http_code}')
          STATUS=$(echo "${RESPONSE}" | tail -n1)
          BODY=$(echo "${RESPONSE}" | sed '$d')
          DELIM="GHOUT_$(date +%s%N)"
          echo "status=${STATUS}" >> "$GITHUB_OUTPUT"
          {
            echo "body<<${DELIM}"
            echo "${BODY}"
            echo "${DELIM}"
          } >> "$GITHUB_OUTPUT"

      - name: Debug API Response (safe)
        env:
          API_STATUS: ${{ steps.api-call.outputs.status }}
          API_BODY: ${{ steps.api-call.outputs.body }}
        run: |
          printf 'API Status: %s\n' "$API_STATUS"
          printf 'API Response Body (raw):\n%s\n' "$API_BODY"

      - name: Check API response (use server-provided markdown only)
        id: check-response
        shell: bash
        run: |
          set -euo pipefail
          STATUS='${{ steps.api-call.outputs.status }}'
          BODY='${{ steps.api-call.outputs.body }}'
          if [[ "${STATUS}" =~ ^2[0-9][0-9]$ ]]; then
            echo "API call successful (status: ${STATUS})"
            MARKDOWN=$(printf '%s' "${BODY}" | jq -e -r '.commentMarkdown')
            DELIM="GHENV_$(date +%s%N)"
            {
              echo "COMMENT_BODY<<${DELIM}"
              printf "%s\n" "${MARKDOWN}"
              echo "${DELIM}"
            } >> "$GITHUB_ENV"
          else
            echo "API call failed with status ${STATUS}"
          echo "COMMENT_BODY=API Ìò∏Ï∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Î†àÌè¨ÏßÄÌÜ†Î¶¨Í∞Ä ÌóàÏö© Î™©Î°ùÏóê ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî. Ìï¥Îãπ Î†àÌè¨Îäî Î∞òÎìúÏãú lab.suhsaechan.me ÏÇ¨Ïù¥Ìä∏ ÎÇ¥Î∂Ä Î™®ÎìàÏóêÏÑú Í∏∞Îä•ÏùÑ Ìïú Î≤àÏù¥ÎùºÎèÑ Ïù¥Ïö©Ìïú Ï†ÅÏù¥ ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§." >> "$GITHUB_ENV"
          fi

      - name: Add comment to Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentBody = process.env.COMMENT_BODY;
            if (!commentBody) {
              core.setFailed('ÎåìÍ∏Ä ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
              return;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });