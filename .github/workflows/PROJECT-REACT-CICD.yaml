# ===================================================================
# React/Next.js ì „ìš© CI/CD ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================

name: PROJECT-REACT-CICD

# ===================================================================
# ğŸ“‹ í•„ìˆ˜ GitHub Secrets ì„¤ì • ê°€ì´ë“œ
# ===================================================================
#
# ğŸ”§ í•„ìˆ˜ Secrets:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Secret ì´ë¦„                 â”‚ ì„¤ëª…                               â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ ENV                         â”‚ React/Next.js í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë‚´ìš©  â”‚
# â”‚ DOCKERHUB_USERNAME          â”‚ DockerHub ì‚¬ìš©ìëª…                 â”‚
# â”‚ DOCKERHUB_TOKEN             â”‚ DockerHub ì•¡ì„¸ìŠ¤ í† í°              â”‚
# â”‚ SERVER_HOST                 â”‚ ë°°í¬ ëŒ€ìƒ ì„œë²„ IP/ë„ë©”ì¸           â”‚
# â”‚ SERVER_USER                 â”‚ ì„œë²„ SSH ì ‘ì† ì‚¬ìš©ìëª…             â”‚
# â”‚ SERVER_PASSWORD             â”‚ ì„œë²„ SSH ì ‘ì† ë¹„ë°€ë²ˆí˜¸             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸ§ª ì„ íƒì  Secrets:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ PROJECT_DEPLOY_PORT         â”‚ deploy ë¸Œëœì¹˜ ë°°í¬ í¬íŠ¸ (ê¸°ë³¸: 3000) â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ===================================================================

on:
  push:
    branches:
      - deploy
  workflow_dispatch:

env:
  PROJECT_NAME: "project"
  DOCKER_IMAGE_PREFIX: "front-container"
  NODE_VERSION: "20.15.0"
  ENV_FILE_NAME: ".env"

jobs:
  build:
    name: React/Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. Node.js ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± (${{ env.ENV_FILE_NAME }})
        run: |
          cat << 'EOF' > ./${{ env.ENV_FILE_NAME }}
          ${{ secrets.ENV }}
          EOF
          echo "âœ… ${{ env.ENV_FILE_NAME }} íŒŒì¼ ìƒì„± ì™„ë£Œ"

      # 4. npm ì˜ì¡´ì„± ìºì‹±
      - name: npm ì˜ì¡´ì„± ìºì‹±
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 5. node_modules ìºì‹±
      - name: node_modules ìºì‹±
        id: node-modules-cache
        uses: actions/cache@v4
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        run: npm ci

      # 7. Next.js ë¹Œë“œ ìºì‹±
      - name: Next.js ë¹Œë“œ ìºì‹±
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      # 8. í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build with npm
        run: npm run build

      # 9. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: Docker ë¹Œë“œí™˜ê²½ ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # 10. DockerHub ë¡œê·¸ì¸
      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 11. Docker ë ˆì´ì–´ ìºì‹±
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('Dockerfile') }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # 12. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}-${{ env.DOCKER_IMAGE_PREFIX }}:${{ github.ref_name }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # 13. Docker ìºì‹œ ì •ë¦¬
      - name: Move Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  deploy:
    name: ì›ê²© ì„œë²„ ë°°í¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 2022
          script: |
            set -e

            # ============================================================
            # ë°°í¬ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            # ============================================================
            echo "ğŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì •.."
            export PATH=$PATH:/usr/local/bin
            export PW=${{ secrets.SERVER_PASSWORD }}

            # GitHubì—ì„œ ì „ë‹¬ë°›ì€ ë¸Œëœì¹˜ëª…
            BRANCH=${{ github.ref_name }}

            # í”„ë¡œì íŠ¸ ì„¤ì •
            PROJECT_NAME="${{ env.PROJECT_NAME }}"

            # ============================================================
            # ë¸Œëœì¹˜ë³„ í¬íŠ¸ ë° ì»¨í…Œì´ë„ˆëª… ì„¤ì •
            # ============================================================
            # ê¸°ë³¸ê°’ ì„¤ì •
            PORT=3000
            CONTAINER_NAME="${PROJECT_NAME}-front"

            # ë¸Œëœì¹˜ì— ë”°ë¥¸ í™˜ê²½ë³„ ì„¤ì •
            if [ "$BRANCH" == "deploy" ] || [ "$BRANCH" == "main" ]; then
              # ğŸš€ ë°°í¬ í™˜ê²½ (deploy ë¸Œëœì¹˜ ë˜ëŠ” main ë¸Œëœì¹˜)
              # GitHub Secretsì˜ PROJECT_DEPLOY_PORT í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
              # ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ 3000 ì‚¬ìš©
              PORT=${{ secrets.PROJECT_DEPLOY_PORT || '3000' }}
              CONTAINER_NAME="${PROJECT_NAME}-front-deploy"
              echo "ğŸš€ ë°°í¬ í™˜ê²½ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤ (ë¸Œëœì¹˜: $BRANCH)"

            else
              # âš ï¸ ê¸°íƒ€ ë¸Œëœì¹˜ (ì˜ˆìƒì¹˜ ëª»í•œ ë¸Œëœì¹˜)
              echo "âš ï¸ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œëœì¹˜ì…ë‹ˆë‹¤: $BRANCH"
              echo "ì´ ì›Œí¬í”Œë¡œìš°ëŠ” deploy ë¸Œëœì¹˜ë§Œ ì§€ì›í•©ë‹ˆë‹¤."
              echo "on.push.branchesì—ì„œ ì§€ì›í•  ë¸Œëœì¹˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”."
              exit 1
            fi

            # ì„¤ì • ì •ë³´ ì¶œë ¥
            echo "ğŸ“‹ ë°°í¬ ì„¤ì • ì •ë³´:"
            echo "  - ë¸Œëœì¹˜: $BRANCH"
            echo "  - í”„ë¡œì íŠ¸: $PROJECT_NAME"
            echo "  - ì»¨í…Œì´ë„ˆ ì´ë¦„: $CONTAINER_NAME"
            echo "  - í¬íŠ¸: $PORT"
            echo "  - Docker ì´ë¯¸ì§€: ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}-${{ env.DOCKER_IMAGE_PREFIX }}:${BRANCH}"

            # ============================================================
            # Docker ì´ë¯¸ì§€ í’€ (Pull)
            # ============================================================
            echo "â¬‡ï¸ Docker ì´ë¯¸ì§€ í’€: ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}-${{ env.DOCKER_IMAGE_PREFIX }}:${BRANCH}"
            echo $PW | sudo -S docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}-${{ env.DOCKER_IMAGE_PREFIX }}:${BRANCH}

            # ============================================================
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            # ============================================================
            echo "ğŸ§¹ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."

            # ë™ì¼í•œ ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if sudo docker ps -a --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}\$"; then
              echo "âš ï¸ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì¡´ì¬í•©ë‹ˆë‹¤. ì¤‘ì§€ ë° ì‚­ì œ ì¤‘..."
              echo $PW | sudo -S docker rm -f $CONTAINER_NAME
              echo "âœ… ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "â„¹ï¸ ì¡´ì¬í•˜ëŠ” ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì—†ìŠµë‹ˆë‹¤."
            fi

            # ============================================================
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # ============================================================
            echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì‹¤í–‰ ì¤‘..."

            echo $PW | sudo -S docker run -d \
              -p ${PORT}:3000 \
              --name $CONTAINER_NAME \
              -e TZ=Asia/Seoul \
              -v /etc/localtime:/etc/localtime:ro \
              ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}-${{ env.DOCKER_IMAGE_PREFIX }}:${BRANCH}

            # ============================================================
            # ë°°í¬ ì™„ë£Œ í™•ì¸
            # ============================================================
            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "ğŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½:"
            echo "  ğŸ¯ í”„ë¡œì íŠ¸: $PROJECT_NAME"
            echo "  ğŸŒ¿ ë¸Œëœì¹˜: $BRANCH"
            echo "  ğŸ³ ì»¨í…Œì´ë„ˆ: $CONTAINER_NAME"
            echo "  ğŸŒ í¬íŠ¸: $PORT"
            echo "  â° ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "ğŸ”— ì ‘ì† URL: http://${{ secrets.SERVER_HOST }}:${PORT}"

# ===================================================================
# ì‚¬ìš© ì˜ˆì‹œ - deploy ë¸Œëœì¹˜ ì‚¬ìš©
# ===================================================================
#
# í˜„ì¬ ì„¤ì •: deploy ë¸Œëœì¹˜ì— pushí•  ë•Œ ìë™ ë°°í¬
# main ë¸Œëœì¹˜ëŠ” ìˆ˜ë™ ì‹¤í–‰(workflow_dispatch)ë§Œ ê°€ëŠ¥
#
# ë¸Œëœì¹˜ë³„ í¬íŠ¸:
# - deploy: 3000 (PROJECT_DEPLOY_PORT secretìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)
# - main: 3000 (ìˆ˜ë™ ì‹¤í–‰ì‹œ, PROJECT_DEPLOY_PORT secretìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)
#
# í•„ìš”í•œ Secrets:
# - REACT_ENV_FILE, DOCKERHUB_*, SERVER_* (í•„ìˆ˜)
# - PROJECT_DEPLOY_PORT (ì„ íƒ, ê¸°ë³¸ê°’: 3000)
#
# ===================================================================

