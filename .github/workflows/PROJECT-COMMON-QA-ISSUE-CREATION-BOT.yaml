# ===================================================================
# ìë™ QA ì´ìŠˆ ìƒì„± ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” GitHub ì´ìŠˆ/PR ëŒ“ê¸€ì—ì„œ @suh-lab ë©˜ì…˜ì„ ê°ì§€í•˜ì—¬
# QA(ì‹œí—˜ìš”ì²­) ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
#
# ì‘ë™ ë°©ì‹:
# 1. ì´ìŠˆ ë˜ëŠ” PR ëŒ“ê¸€ì—ì„œ "@suh-lab" + "create" + "qa" ê°ì§€ (ìˆœì„œ ë¬´ê´€)
# 2. ëŒ“ê¸€ì— ğŸ‘€ ë¦¬ì•¡ì…˜ ì¶”ê°€ (í™•ì¸ í‘œì‹œ)
# 3. ì›ë³¸ ì´ìŠˆ/PR ì œëª© ë˜ëŠ” ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
# 4. ì œëª©ì—ì„œ ë¶ˆí•„ìš”í•œ ì´ëª¨ì§€ ë° í‚¤ì›Œë“œ ì œê±°
# 5. "ğŸ” [ì‹œí—˜ìš”ì²­]" ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ QA ì´ìŠˆ ìƒì„±
# 6. ì‹œí—˜ í…œí”Œë¦¿ì´ ì ìš©ëœ ë³¸ë¬¸ ìë™ ìƒì„±
# 7. ì›ë³¸ ì´ìŠˆ/PRì— QA ì´ìŠˆ ë§í¬ ëŒ“ê¸€ ì‘ì„±
#
# ì§€ì› ê¸°ëŠ¥:
# - ì´ìŠˆì™€ PR ëª¨ë‘ ì§€ì›
# - PR ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ìë™ ì¶”ì¶œ
# - ëª…ë ¹ì–´ ìˆœì„œ ë¬´ê´€ (@suh-lab create qa, @suh-lab qa create ëª¨ë‘ ê°€ëŠ¥)
# - ì´ëª¨ì§€ ìë™ ì œê±° (ğŸš€, ğŸ”¥, âŒ› ë“±)
# - ì´ìŠˆ íƒ€ì… í‚¤ì›Œë“œ ì œê±° ([ë²„ê·¸], [ë””ìì¸], [ê¸°ëŠ¥ìš”ì²­] ë“±)
# - ì¹´í…Œê³ ë¦¬ ë° ë‚´ìš© ìë™ ì¶”ì¶œ
# - QA í…œí”Œë¦¿ ìë™ ì ìš©
# - ë‹´ë‹¹ì ìë™ í• ë‹¹
# - í™•ì¸ ë¦¬ì•¡ì…˜ (ğŸ‘€) ìë™ ì¶”ê°€
#
# ì‚¬ìš© ì˜ˆì‹œ:
# ì›ë³¸ ì´ìŠˆ: "ğŸš€ [ê¸°ëŠ¥ê°œë°œ][ë¡œê·¸ì¸] ì†Œì…œ ë¡œê·¸ì¸ ì¶”ê°€"
# QA ì´ìŠˆ: "ğŸ” [ì‹œí—˜ìš”ì²­][ë¡œê·¸ì¸] ì†Œì…œ ë¡œê·¸ì¸ ì¶”ê°€"
#
# íŠ¸ë¦¬ê±° ë°©ë²•:
# ì´ìŠˆ/PR ëŒ“ê¸€ì— "@suh-lab create qa" ë˜ëŠ” "@suh-lab qa create" ì…ë ¥
#
# ===================================================================

name: PROJECT-CREATE-QA-ISSUE

on:
  issue_comment:
    types: [created]

# ===================================================================
# ì„¤ì • ë³€ìˆ˜
# ===================================================================
env:
  # QA ì´ìŠˆ ê¸°ë³¸ ë‹´ë‹¹ì ì„¤ì •
  # - 'default': ëŒ“ê¸€ ì‘ì„±ìê°€ ë‹´ë‹¹ìë¡œ ì§€ì •ë¨
  # - GitHub ID (ì˜ˆ: 'Cassiiopeia'): í•´ë‹¹ ì‚¬ìš©ìê°€ ë‹´ë‹¹ìë¡œ ì§€ì •ë¨
  DEFAULT_QA_ASSIGNEE: 'default'

jobs:
  create-qa:
    # @suh-labê³¼ create, qa í‚¤ì›Œë“œê°€ ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì‹¤í–‰ (ìˆœì„œ ë¬´ê´€)
    if: |
      contains(github.event.comment.body, '@suh-lab') && 
      contains(github.event.comment.body, 'create') &&
      contains(github.event.comment.body, 'qa')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: ëŒ“ê¸€ì— ğŸ‘€ ë¦¬ì•¡ì…˜ ì¶”ê°€
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              content: 'eyes'
            });
            
            console.log('ğŸ‘€ ëŒ“ê¸€ì— í™•ì¸ ë¦¬ì•¡ì…˜ ì¶”ê°€ ì™„ë£Œ');

      - name: QA ì´ìŠˆ ìƒì„±
        uses: actions/github-script@v7
        env:
          DEFAULT_QA_ASSIGNEE: ${{ env.DEFAULT_QA_ASSIGNEE }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const commenter = context.payload.comment.user.login;

            // ë‹´ë‹¹ì ê²°ì •: 'default'ë©´ ëŒ“ê¸€ ì‘ì„±ì, ê·¸ ì™¸ì—ëŠ” ì§€ì •ëœ GitHub ID
            const defaultAssignee = process.env.DEFAULT_QA_ASSIGNEE || 'default';
            const assignee = (defaultAssignee === 'default') ? commenter : defaultAssignee;
            console.log(`ğŸ‘¤ ë‹´ë‹¹ì ì„¤ì •: ${assignee} (ì„¤ì •ê°’: ${defaultAssignee})`);
            const issueOrPrNumber = issue.number;
            const isPullRequest = !!issue.pull_request;
            
            console.log(`ğŸ“Œ íƒ€ì…: ${isPullRequest ? 'Pull Request' : 'Issue'}`);
            console.log(`ğŸ“Œ ë²ˆí˜¸: #${issueOrPrNumber}`);
            
            let originalIssueNumber = issueOrPrNumber;
            let title = issue.title;
            
            // PRì¸ ê²½ìš° ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
            if (isPullRequest) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issueOrPrNumber
              });
            
              const branchName = pr.head.ref;
              console.log(`ğŸŒ¿ ë¸Œëœì¹˜ëª…: ${branchName}`);
            
              // ë¸Œëœì¹˜ëª…ì—ì„œ #31 í˜•íƒœì˜ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
              const issueMatch = branchName.match(/#(\d+)/);
              if (issueMatch) {
                originalIssueNumber = parseInt(issueMatch[1]);
                console.log(`ğŸ” ì¶”ì¶œëœ ì´ìŠˆ ë²ˆí˜¸: #${originalIssueNumber}`);
            
                // ì›ë³¸ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                try {
                  const { data: originalIssue } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: originalIssueNumber
                  });
                  title = originalIssue.title;
                  console.log(`ğŸ“‹ ì›ë³¸ ì´ìŠˆ ì œëª©: ${title}`);
                } catch (error) {
                  console.log(`âš ï¸ ì´ìŠˆ #${originalIssueNumber}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ PR ì œëª© ì‚¬ìš©`);
                }
              }
            }
            
            console.log('ğŸ“ ì›ë³¸ ì œëª©:', title);
            
            // 1. ì´ëª¨ì§€ ì œê±°
            title = title.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                        .replace(/[\u{2600}-\u{26FF}]/gu, '')
                        .replace(/[\u{2700}-\u{27BF}]/gu, '');
            
            // 2. íŠ¹ì • í‚¤ì›Œë“œ ì•ë¶€ë¶„ê¹Œì§€ ì œê±°
            const keywordPattern = /^.*?\[(ë²„ê·¸|ë””ìì¸|ê¸°ëŠ¥ìš”ì²­|ê¸°ëŠ¥ì¶”ê°€|ê¸°ëŠ¥ê°œì„ )\]/;
            title = title.replace(keywordPattern, '');
            
            // 3. ê³µë°± ì •ë¦¬
            title = title.replace(/^\s+/, '').trim();
            console.log('âœ¨ ì •ì œëœ ì œëª©:', title);
            
            // 4. QA ì´ìŠˆ ì œëª© ìƒì„±
            const qaTitle = `ğŸ” [ì‹œí—˜ìš”ì²­]${title}`;
            console.log('ğŸ¯ QA ì´ìŠˆ ì œëª©:', qaTitle);
            
            // QA ì´ìŠˆ ë³¸ë¬¸ ìƒì„±
            const qaBody = `ğŸ”— ISSUE ì •ë³´
            ---
            - #${originalIssueNumber}
            ${isPullRequest ? `- PR: #${issueOrPrNumber}` : ''}

            ğŸ”— PR ì •ë³´
            ---
            ${isPullRequest ? `- #${issueOrPrNumber}` : '<!-- PR ë²ˆí˜¸ë‚˜ URLì„ ì‘ì„±í•´ì£¼ì„¸ìš” -->'}

            ğŸ§© ì‹œí—˜ ëŒ€ìƒ
            ---

            ${title.replace(/^\[.*?\]\s*/, '')}ì— ëŒ€í•œ ê¸°ëŠ¥ ì‹œí—˜

            ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
            ---

            1. ê¸°ë³¸ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
            2. ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
            3. UI/UX í™•ì¸
            4. ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸

            âš™ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½
            ---
            - **í”„ë¡œì íŠ¸ Version**: 
            - **OS**: 
            - **ë¸Œë¼ìš°ì €**: 
            - **ê¸°ê¸°**: 

            ğŸ™‹â€â™‚ï¸ ë‹´ë‹¹ì
            ---

            - **ì‹œí—˜ë‹´ë‹¹**: ì´ë¦„
            - **ìš”ì²­ì**: @${issue.user.login}

            ---
            *ğŸ¤– ì´ ì´ìŠˆëŠ” @suh-lab ë´‡ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

            try {
              // QA ì´ìŠˆ ìƒì„±
              const { data: qaIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: qaTitle,
                body: qaBody,
                labels: ['ì‘ì—… ì „'],
                assignees: [assignee]
              });
            
              console.log(`âœ… QA ì´ìŠˆ ìƒì„± ì™„ë£Œ: #${qaIssue.number}`);
            
              // ì›ë³¸ ì´ìŠˆ/PRì— ëŒ“ê¸€
              const commentBody = isPullRequest
                ? [
                    'âœ… **ì‹œí—˜(QA) ìš”ì²­ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**',
                    '',
                    'ğŸ“‹ **ì‹œí—˜(QA) ìš”ì²­**',
                    `- #${qaIssue.number}`,
                    '',
                    'ğŸ”— **ì´ìŠˆì •ë³´**',
                    `- #${originalIssueNumber}`,
                    '',
                    'ì‹œí—˜ ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ QA ì´ìŠˆì— ê¸°ë¡í•´ì£¼ì„¸ìš”.'
                  ].join('\n')
                : [
                    'âœ… **ì‹œí—˜(QA) ìš”ì²­ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**',
                    '',
                    'ğŸ“‹ **ì‹œí—˜(QA) ìš”ì²­**',
                    `- #${qaIssue.number}`,
                    '',
                    'ì‹œí—˜ ì™„ë£Œ í›„ ê²°ê³¼ë¥¼ QA ì´ìŠˆì— ê¸°ë¡í•´ì£¼ì„¸ìš”.'
                  ].join('\n');
            
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueOrPrNumber,
                body: commentBody
              });
            
              console.log('ğŸ’¬ ì›ë³¸ì— ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ');
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
              console.log('ğŸ‰ QA ì´ìŠˆ ìƒì„± í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!');
              console.log(`  â€¢ ${isPullRequest ? 'PR' : 'Issue'}: #${issueOrPrNumber}`);
              console.log(`  â€¢ ì›ë³¸ Issue: #${originalIssueNumber}`);
              console.log(`  â€¢ QA Issue: #${qaIssue.number}`);
              console.log(`  â€¢ ë‹´ë‹¹ì: @${assignee}`);
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            } catch (error) {
              console.error('âŒ ì—ëŸ¬ ë°œìƒ:', error);
            
              // ì—ëŸ¬ ë°œìƒ ì‹œ ëŒ“ê¸€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueOrPrNumber,
                body: `âŒ QA ì´ìŠˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n\`\`\`\n${error.message}\n\`\`\``
              });
            }