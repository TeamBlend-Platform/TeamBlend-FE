# ===================================================================
# ë²”ìš© í”„ë¡œì íŠ¸ ìë™ ì²´ì¸ì§€ë¡œê·¸ ê´€ë¦¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” deploy ë¸Œëœì¹˜ë¡œ PRì´ ìƒì„±ë  ë•Œ CodeRabbit AIì˜ ë¦¬ë·°ë¥¼
# ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  íŒŒì‹±í•˜ì—¬ CHANGELOG.jsonê³¼ CHANGELOG.mdë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
#
# ì‘ë™ ë°©ì‹:
# 1. deploy ë¸Œëœì¹˜ë¡œ PR ìƒì„± ì‹œ íŠ¸ë¦¬ê±°
# 2. PR ì œëª©ì„ ì¦‰ì‹œ ğŸš€ Deploy í˜•ì‹ìœ¼ë¡œ ë³€ê²½
# 3. CodeRabbit Summary ìš”ì²­ í›„ ìµœëŒ€ 10ë¶„ ëŒ€ê¸°
# 4. Summary ë‚´ìš©ì„ íŒŒì‹±í•˜ì—¬ CHANGELOG íŒŒì¼ë“¤ ì—…ë°ì´íŠ¸
# 5. PR ìë™ ë¨¸ì§€ í›„ ë°°í¬ íŠ¸ë¦¬ê±°
#
# API Rate Limit ì°¸ê³ :
# - GITHUB_TOKEN: 1,000 ìš”ì²­/ì‹œê°„/ë ˆí¬ (Actions ë‚´)
# - PAT: 5,000 ìš”ì²­/ì‹œê°„/ê³„ì •
# - ì´ ì›Œí¬í”Œë¡œìš° ì˜ˆìƒ ì‚¬ìš©ëŸ‰: ~130íšŒ/ì‹¤í–‰
#
# ===================================================================

name: AUTO UPDATE PROJECT CHANGELOG

on:
  pull_request_target:
    types: [opened]
    branches: ["deploy"]

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 1: CodeRabbit Summary ê°ì§€ ë° íŒŒì‹±
  detect-and-parse:
    name: CodeRabbit Summary ê°ì§€ ë° íŒŒì‹±
    runs-on: ubuntu-latest
    outputs:
      summary_found: ${{ steps.detect_summary.outputs.summary_found }}
      version: ${{ steps.get_version.outputs.version }}
      project_type: ${{ steps.get_version.outputs.project_type }}
    steps:
      - name: PR ë³¸ë¬¸ ì´ˆê¸°í™”
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "ğŸ—‘ï¸ PR #$PR_NUMBER ë³¸ë¬¸ ì´ˆê¸°í™” ì¤‘..."

          curl -s -H "Authorization: token ${{ secrets._GITHUB_PAT_TOKEN }}" \
               -H "Content-Type: application/json" \
               -X PATCH \
               -d '{"body": ""}' \
               "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}"

          echo "âœ… PR ë³¸ë¬¸ ì´ˆê¸°í™” ì™„ë£Œ"

      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch || 'main' }}

      - name: ë²„ì „ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          if [ -f ".github/scripts/version_manager.sh" ]; then
            chmod +x .github/scripts/version_manager.sh
            echo "âœ… ë²„ì „ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
          fi

      - name: ë²„ì „ ì •ë³´ í™•ì¸
        id: get_version
        run: |
          VERSION="1.0.0"
          PROJECT_TYPE="unknown"

          # ë²„ì „ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©
          if [ -f ".github/scripts/version_manager.sh" ]; then
            VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          elif [ -f "version.yml" ]; then
            VERSION=$(grep "^version:" version.yml | sed 's/version: *"\([^"]*\)".*/\1/')
          # í´ë°±: í”„ë¡œì íŠ¸ íƒ€ì…ë³„ ë²„ì „ íŒŒì¼
          elif [ -f "build.gradle" ]; then
            VERSION=$(grep "version = '" build.gradle | sed "s/version = '//" | sed "s/'//")
            PROJECT_TYPE="spring"
          elif [ -f "pubspec.yaml" ]; then
            VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: *\([0-9.]*\).*/\1/')
            PROJECT_TYPE="flutter"
          elif [ -f "package.json" ]; then
            VERSION=$(jq -r '.version' package.json)
            PROJECT_TYPE="node"
          elif [ -f "pyproject.toml" ]; then
            VERSION=$(grep "^version = " pyproject.toml | sed 's/version = *"\([^"]*\)".*/\1/')
            PROJECT_TYPE="python"
          fi

          # version.ymlì—ì„œ í”„ë¡œì íŠ¸ íƒ€ì… í™•ì¸
          if [ -f "version.yml" ] && [ "$PROJECT_TYPE" = "unknown" ]; then
            PROJECT_TYPE=$(grep "^project_type:" version.yml | sed 's/project_type: *"\([^"]*\)".*/\1/' || echo "unknown")
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… ë²„ì „: $VERSION, í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"

      - name: PR ì œëª© ì¦‰ì‹œ ë³€ê²½
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          VERSION="${{ steps.get_version.outputs.version }}"
          TODAY=$(date '+%Y%m%d')
          NEW_TITLE="ğŸš€ Deploy ${TODAY}-v${VERSION}"

          curl -s -H "Authorization: token ${{ secrets._GITHUB_PAT_TOKEN }}" \
               -H "Content-Type: application/json" \
               -X PATCH \
               -d "{\"title\": \"${NEW_TITLE}\"}" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}"

          echo "âœ… PR ì œëª© ë³€ê²½ ì™„ë£Œ: $NEW_TITLE"

      - name: CodeRabbit Summary ìš”ì²­
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          curl -s -H "Authorization: token ${{ secrets._GITHUB_PAT_TOKEN }}" \
               -H "Content-Type: application/json" \
               -X POST \
               -d '{"body": "@coderabbitai summary"}' \
               "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"

          echo "âœ… CodeRabbit Summary ìš”ì²­ ì™„ë£Œ"

      - name: CodeRabbit Summary ê°ì§€ (í´ë§)
        id: detect_summary
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          MAX_ATTEMPTS=120  # 10ë¶„ = 120 * 5ì´ˆ
          ATTEMPT=0

          echo "ğŸ” PR #$PR_NUMBERì—ì„œ CodeRabbit Summary ê°ì§€ ì‹œì‘..."
          echo "â° ìµœëŒ€ ëŒ€ê¸° ì‹œê°„: 10ë¶„ (5ì´ˆë§ˆë‹¤ ì²´í¬)"

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "[$ATTEMPT/$MAX_ATTEMPTS] Summary í™•ì¸ ì¤‘... ($(date '+%H:%M:%S'))"

            # JSON APIë¡œ PR body ê°€ì ¸ì˜¤ê¸° (Public/Private ë™ì¼í•˜ê²Œ ë™ì‘)
            PR_BODY=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                           "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}" | \
                           jq -r '.body // ""')

            # ë³¸ë¬¸ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
            if [ -z "$PR_BODY" ] || [ "$PR_BODY" = "null" ]; then
              echo "â³ PR ë³¸ë¬¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            elif echo "$PR_BODY" | grep -q "Summary by CodeRabbit"; then
              echo "âœ… CodeRabbit Summary ë°œê²¬!"
              echo "$PR_BODY" > pr_body.md
              echo "summary_found=true" >> $GITHUB_OUTPUT
              break
            else
              echo "â³ CodeRabbit Summary ì•„ì§ ì—†ìŒ"
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 5
            fi
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âš ï¸ 10ë¶„ ëŒ€ê¸° í›„ì—ë„ Summaryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "summary_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary íŒŒì¼ ì—…ë¡œë“œ
        if: steps.detect_summary.outputs.summary_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-content
          path: pr_body.md
          retention-days: 1

  # Job 2: CHANGELOG ì—…ë°ì´íŠ¸
  update-changelog:
    name: CHANGELOG ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    needs: detect-and-parse
    if: needs.detect-and-parse.outputs.summary_found == 'true'
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch || 'main' }}

      - name: Git ì„¤ì •
        run: |
          DEFAULT_BRANCH="${{ github.event.repository.default_branch || 'main' }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin $DEFAULT_BRANCH

      - name: Summary íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: pr-content

      - name: CHANGELOG ì—…ë°ì´íŠ¸
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          VERSION="${{ needs.detect-and-parse.outputs.version }}"
          PROJECT_TYPE="${{ needs.detect-and-parse.outputs.project_type }}"
          TODAY=$(date '+%Y-%m-%d')
          TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%SZ')

          echo "ğŸ“ CHANGELOG ì—…ë°ì´íŠ¸ ì‹œì‘..."
          echo "ğŸ“‹ í”„ë¡œì íŠ¸: $PROJECT_TYPE v$VERSION"

          # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
          if [ -f ".github/scripts/changelog_manager.py" ]; then
            chmod +x .github/scripts/changelog_manager.py
          else
            echo "âŒ changelog_manager.pyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í›„ Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          export VERSION="$VERSION"
          export PROJECT_TYPE="$PROJECT_TYPE"
          export TODAY="$TODAY"
          export PR_NUMBER="$PR_NUMBER"
          export TIMESTAMP="$TIMESTAMP"

          python3 .github/scripts/changelog_manager.py update-from-summary

          echo "ğŸ“„ CHANGELOG.md ì¬ìƒì„± ì¤‘..."
          python3 .github/scripts/changelog_manager.py generate-md

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          DEFAULT_BRANCH="${{ github.event.repository.default_branch || 'main' }}"
          git add CHANGELOG.json CHANGELOG.md

          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            REPO_NAME=$(basename "${{ github.repository }}")
            VERSION="${{ needs.detect-and-parse.outputs.version }}"

            git commit -m "$REPO_NAME ë²„ì „ ê´€ë¦¬ : docs : v$VERSION ë¦´ë¦¬ì¦ˆ ë¬¸ì„œ ì—…ë°ì´íŠ¸ (PR #${{ github.event.pull_request.number }})"
            git push origin HEAD:$DEFAULT_BRANCH
            echo "âœ… ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ"
          fi

      - name: ì„ì‹œ íŒŒì¼ ì •ë¦¬
        run: rm -f pr_body.md

  # Job 3: PR ë¨¸ì§€ ë° ë°°í¬ íŠ¸ë¦¬ê±°
  merge-and-deploy:
    name: PR ë¨¸ì§€ ë° ë°°í¬ íŠ¸ë¦¬ê±°
    runs-on: ubuntu-latest
    needs: [detect-and-parse, update-changelog]
    if: needs.detect-and-parse.outputs.summary_found == 'true'
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets._GITHUB_PAT_TOKEN }}
          fetch-depth: 0

      - name: Git ì„¤ì •
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: PR ë¸Œëœì¹˜ ìµœì‹ í™”
        env:
          GH_TOKEN: ${{ secrets._GITHUB_PAT_TOKEN }}
        run: |
          PR_HEAD=$(gh pr view ${{ github.event.pull_request.number }} --json headRefName -q .headRefName)
          PR_BASE=$(gh pr view ${{ github.event.pull_request.number }} --json baseRefName -q .baseRefName)

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ PR ì •ë³´:"
          echo "  â€¢ HEAD ë¸Œëœì¹˜: $PR_HEAD"
          echo "  â€¢ BASE ë¸Œëœì¹˜: $PR_BASE"
          echo "  â€¢ ëª©í‘œ: $PR_BASE ë¸Œëœì¹˜ì— $PR_HEADì˜ ë³€ê²½ì‚¬í•­ì„ ë¨¸ì§€"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ì›ê²© ë¸Œëœì¹˜ ìµœì‹ í™”
          echo "ğŸ”„ ì›ê²© ë¸Œëœì¹˜ ìµœì‹ í™” ì¤‘..."
          git fetch origin $PR_HEAD
          git fetch origin $PR_BASE

          # BASE ë¸Œëœì¹˜(deploy)ë¡œ ì²´í¬ì•„ì›ƒ
          echo "ğŸ“¦ $PR_BASE ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ì¤‘..."
          git checkout $PR_BASE
          git pull origin $PR_BASE

          # HEAD ë¸Œëœì¹˜(main)ì˜ ë³€ê²½ì‚¬í•­ì„ BASE(deploy)ì— ë¨¸ì§€
          echo "ğŸ”€ $PR_HEADì˜ ë³€ê²½ì‚¬í•­ì„ $PR_BASEì— ë¨¸ì§€ ì¤‘..."
          if git merge --no-edit origin/$PR_HEAD; then
            echo "âœ… ë¨¸ì§€ ì„±ê³µ"
          else
            echo "âš ï¸ ë¨¸ì§€ ì¶©ëŒ ë°œìƒ"
            echo "ì¶©ëŒ íŒŒì¼:"
            git diff --name-only --diff-filter=U || true
            echo "âŒ ë¨¸ì§€ ì¶©ëŒë¡œ ì¸í•´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í•´ê²° í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
            exit 1
          fi

          # deploy ë¸Œëœì¹˜ì— í‘¸ì‹œ (ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°)
          echo "ğŸš€ $PR_BASE ë¸Œëœì¹˜ì— í‘¸ì‹œ ì¤‘..."
          if git push origin $PR_BASE; then
            echo "âœ… $PR_BASE ë¸Œëœì¹˜ì— í‘¸ì‹œ ì™„ë£Œ (ë°°í¬ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°ë¨)"
          else
            echo "âŒ í‘¸ì‹œ ì‹¤íŒ¨"
            exit 1
          fi

      - name: ìë™ PR Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          # PAT í† í° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ -z "${{ secrets._GITHUB_PAT_TOKEN }}" ]; then
            PAT_AVAILABLE="false"
          else
            PAT_AVAILABLE="true"
          fi
          
          # PR ìƒíƒœ í™•ì¸
          PR_STATE=$(gh pr view $PR_NUMBER --json state,mergeable -q '.state + "," + (.mergeable | tostring)')
          PR_STATE_VALUE=$(echo "$PR_STATE" | cut -d',' -f1)
          PR_MERGEABLE=$(echo "$PR_STATE" | cut -d',' -f2)

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ PR ìƒíƒœ í™•ì¸:"
          echo "  â€¢ ìƒíƒœ: $PR_STATE_VALUE"
          echo "  â€¢ ë³‘í•© ê°€ëŠ¥: $PR_MERGEABLE"
          echo "  â€¢ PAT í† í° ì‚¬ìš© ê°€ëŠ¥: $PAT_AVAILABLE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$PR_STATE_VALUE" = "CLOSED" ] || [ "$PR_STATE_VALUE" = "MERGED" ]; then
            echo "âœ… PRì´ ì´ë¯¸ ë‹«í˜”ê±°ë‚˜ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤"
            exit 0
          fi

          if [ "$PR_MERGEABLE" != "true" ]; then
            echo "âš ï¸ PRì„ GitHub APIë¡œ ë³‘í•©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "ğŸ’¡ ì´ë¯¸ 'PR ë¸Œëœì¹˜ ìµœì‹ í™”' ë‹¨ê³„ì—ì„œ ë³€ê²½ì‚¬í•­ì´ deploy ë¸Œëœì¹˜ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤"
            echo "ğŸ“ PR ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
          
            # PRì— ëŒ“ê¸€ ì¶”ê°€
            export GH_TOKEN=${{ secrets.GITHUB_TOKEN }}
            gh pr comment $PR_NUMBER --body "âœ… ë³€ê²½ì‚¬í•­ì´ ìë™ìœ¼ë¡œ deploy ë¸Œëœì¹˜ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. PRì„ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì„¸ìš”."
          
            echo "âœ… PR ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            exit 0
          fi

          # ë¨¸ì§€ ì„±ê³µ ì—¬ë¶€ ì¶”ì  ë³€ìˆ˜
          MERGE_SUCCESS="false"

          # 1ì°¨ ì‹œë„: GITHUB_TOKENìœ¼ë¡œ ë¨¸ì§€ ì‹œë„ (--admin ì—†ì´)
          echo ""
          echo "ğŸ”€ 1ì°¨ ì‹œë„: GITHUB_TOKENìœ¼ë¡œ PR ë³‘í•© ì¤‘..."
          export GH_TOKEN=${{ secrets.GITHUB_TOKEN }}
          
          MERGE_OUTPUT=$(gh pr merge $PR_NUMBER --merge --delete-branch=false 2>&1)
          MERGE_EXIT_CODE=$?
          
          if [ $MERGE_EXIT_CODE -eq 0 ] && echo "$MERGE_OUTPUT" | grep -q "merged\|Merged"; then
            echo "âœ… GITHUB_TOKENìœ¼ë¡œ PR ë³‘í•© ì„±ê³µ"
            MERGE_SUCCESS="true"
          else
            echo "âš ï¸ GITHUB_TOKENìœ¼ë¡œ ë³‘í•© ì‹¤íŒ¨"
            echo "   ì¶œë ¥: $MERGE_OUTPUT"
          
            # PR ìƒíƒœ ì¬í™•ì¸ (ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ë¨¸ì§€í–ˆì„ ìˆ˜ ìˆìŒ)
            PR_STATE_CHECK=$(gh pr view $PR_NUMBER --json state -q .state)
            if [ "$PR_STATE_CHECK" = "MERGED" ]; then
              echo "âœ… PRì´ ì´ë¯¸ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"
              MERGE_SUCCESS="true"
            fi
          fi

          # 2ì°¨ ì‹œë„: PAT í† í°ìœ¼ë¡œ ì¬ì‹œë„ (--admin í”Œë˜ê·¸ ì‚¬ìš©)
          if [ "$MERGE_SUCCESS" = "false" ] && [ "$PAT_AVAILABLE" = "true" ]; then
            echo ""
            echo "ğŸ”€ 2ì°¨ ì‹œë„: PAT í† í°ìœ¼ë¡œ PR ë³‘í•© ì¤‘ (--admin í”Œë˜ê·¸ ì‚¬ìš©)..."
            export GH_TOKEN=${{ secrets._GITHUB_PAT_TOKEN }}
          
            MERGE_OUTPUT=$(gh pr merge $PR_NUMBER --merge --admin --delete-branch=false 2>&1)
            MERGE_EXIT_CODE=$?
          
            if [ $MERGE_EXIT_CODE -eq 0 ] && echo "$MERGE_OUTPUT" | grep -q "merged\|Merged"; then
              echo "âœ… PAT í† í°ìœ¼ë¡œ PR ë³‘í•© ì„±ê³µ"
              MERGE_SUCCESS="true"
            else
              echo "âŒ PAT í† í°ìœ¼ë¡œë„ ë³‘í•© ì‹¤íŒ¨"
              echo "   ì¶œë ¥: $MERGE_OUTPUT"
          
              # PR ìƒíƒœ ì¬í™•ì¸
              PR_STATE_CHECK=$(gh pr view $PR_NUMBER --json state -q .state)
              if [ "$PR_STATE_CHECK" = "MERGED" ]; then
                echo "âœ… PRì´ ì´ë¯¸ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤"
                MERGE_SUCCESS="true"
              fi
            fi
          fi

          # ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬
          if [ "$MERGE_SUCCESS" = "false" ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ PR ìë™ ë³‘í•© ì‹¤íŒ¨"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
            if [ "$PAT_AVAILABLE" = "false" ]; then
              echo ""
              echo "âš ï¸ PAT í† í°ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo ""
              echo "ğŸ“‹ í•´ê²° ë°©ë²•:"
              echo "1. GitHubì—ì„œ Personal Access Token ìƒì„±"
              echo "   - https://github.com/settings/tokens"
              echo "   - ê¶Œí•œ: repo (ì „ì²´ ê¶Œí•œ)"
              echo ""
              echo "2. Repository Secretsì— ë“±ë¡"
              echo "   - Settings > Secrets and variables > Actions"
              echo "   - New repository secret"
              echo "   - Name: _GITHUB_PAT_TOKEN"
              echo "   - Value: ìƒì„±í•œ í† í°"
              echo ""
              echo "ë˜ëŠ”"
              echo ""
              echo "3. Branch Protection Rules ì¡°ì •"
              echo "   - Settings > Branches > Branch protection rules"
              echo "   - 'Allow specified actors to bypass required pull requests'"
              echo "   - GitHub Actions botì„ ì˜ˆì™¸ë¡œ ì¶”ê°€"
              echo ""
            else
              echo ""
              echo "âš ï¸ GITHUB_TOKENê³¼ PAT í† í° ëª¨ë‘ë¡œ ë³‘í•©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              echo ""
              echo "ğŸ“‹ ê°€ëŠ¥í•œ ì›ì¸:"
              echo "1. Branch Protection Rulesê°€ ë„ˆë¬´ ì—„ê²©í•¨"
              echo "2. PRì— ì¶©ëŒì´ ìˆìŒ"
              echo "3. í•„ìˆ˜ ìƒíƒœ ì²´í¬ê°€ í†µê³¼í•˜ì§€ ì•ŠìŒ"
              echo "4. í•„ìˆ˜ ë¦¬ë·° ìŠ¹ì¸ì´ ì—†ìŒ"
              echo ""
            fi
          
            # PRì— ëŒ“ê¸€ ì¶”ê°€
            export GH_TOKEN=${{ secrets.GITHUB_TOKEN }}
            ERROR_COMMENT="âŒ ìë™ ë³‘í•© ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³‘í•©í•´ì£¼ì„¸ìš”."
            if [ "$PAT_AVAILABLE" = "false" ]; then
              ERROR_COMMENT="âŒ ìë™ ë³‘í•© ì‹¤íŒ¨: PAT í† í°ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. Settings > Secretsì— \`_GITHUB_PAT_TOKEN\`ì„ ë“±ë¡í•˜ê±°ë‚˜ Branch Protection Rulesì—ì„œ GitHub Actions botì„ ì˜ˆì™¸ë¡œ ì¶”ê°€í•´ì£¼ì„¸ìš”."
            fi
            gh pr comment $PR_NUMBER --body "$ERROR_COMMENT"
          
            exit 1
          fi
          
          echo ""
          echo "âœ… PR ìë™ ë³‘í•© ì™„ë£Œ"

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ì²´ì¸ì§€ë¡œê·¸ ì—…ë°ì´íŠ¸ ë° ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ë°°í¬ ì •ë³´:"
          echo "  â€¢ ë²„ì „: ${{ needs.detect-and-parse.outputs.version }}"
          echo "  â€¢ í”„ë¡œì íŠ¸: ${{ needs.detect-and-parse.outputs.project_type }}"
          echo "  â€¢ PR: #${{ github.event.pull_request.number }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
